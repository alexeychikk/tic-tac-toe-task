<!DOCTYPE html>
<html>
	<head>
		<title>Parcel Sandbox</title>
		<meta charset="UTF-8" />

		<style>
			html {
				height: 100%;
			}
			body {
				font-family: sans-serif;
				height: 100%;
			}

			#app {
				display: flex;
				justify-content: center;
				align-items: center;
				height: 100%;
			}

			.field {
				user-select: none;
			}

			.row {
				display: flex;
			}

			.col {
				width: 50px;
				height: 50px;
				border: 2px solid gray;
				display: flex;
				font-size: 36px;
				font-weight: 700;
				justify-content: center;
				align-items: center;
			}
			.col:not(.filled) {
				cursor: pointer;
			}
			.col:hover:not(.filled) {
				background-color: #ccff90;
			}

			.col > * {
				line-height: 1;
			}
		</style>
		<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21"></script>
	</head>

	<body>
		<div id="app"></div>

		<script>
			const fieldSize = 3;

			// –¢—É—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª—è, –ø–æ–∫–∞ –Ω–µ –≤–¥–∞–≤–∞–π—Å—è –≤ –¥–µ—Ç–∞–ª–∏
			// —Ö–æ—Ç—è —Ç—É—Ç –Ω–∏—á–µ–≥–æ —Å–ª–æ–∂–Ω–æ–≥–æ, –µ—Å–ª–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è
			document.getElementById("app").innerHTML = `
<div class="field"> 
  ${_.times(
		fieldSize,
		(i) => `
  <div class="row" id="row${i}">
    ${_.times(
			fieldSize,
			(j) => `<div class="col" id="col${i * fieldSize + j}"></div>`
		).join("")}
  </div>`
	).join("")}
</div>
`;

			// –¢—É—Ç —è –±–µ—Ä—É –∫–∞–∂–¥—É—é –∫–ª–µ—Ç–∫—É –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é —Å–æ–±—ã—Ç–∏–µ —á—Ç–æ–±—ã
			// –ø–æ –Ω–∞–∂–∞—Ç–∏—é –õ–ö–ú –ø–æ –∫–ª–µ—Ç–∫–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å —Ñ—É–Ω–∫—Ü–∏—è
			// —Ç–æ–∂–µ –ø–æ–∫–∞ –Ω–µ –≤–¥–∞–≤–∞–π—Å—è –≤ –¥–µ—Ç–∞–ª–∏
			_.times(fieldSize * fieldSize, (i) => {
				const cellEl = document.getElementById(`col${i}`);
				cellEl.onclick = () => handleCellClick(i, cellEl.dataset.fillSign);
			});

			// –í–æ—Ç —Ç—É—Ç —É–∂–µ –ø—Ä–∏–¥—ë—Ç—Å—è —Ç–µ–±–µ –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å.
			// üëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüñïüëáüëáüëá
			/**
			 * –ù–µ –ø—É–≥–∞–π—Å—è —Ç–∞–∫–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è. –≠—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è JSDoc. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç
			 * –¥–æ–±–∞–≤–ª—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º —Ñ—É–Ω–∫—Ü–∏–π –∏ —Ç.–ø.
			 * –Ø –∑–¥–µ—Å—å –æ–ø–∏—à—É, —á—Ç–æ –∑–Ω–∞—á–∏—Ç –∫–∞–∂–¥—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä, —á—Ç–æ–±—ã —Ç—ã –ø–æ–Ω–∏–º–∞–ª,
			 * –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π –∏ —á—Ç–æ –≤ –∏—Ç–æ–≥–µ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å.
			 * –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ —Ç—ã –∫–ª–∏–∫–∞–µ—à—å –ª–µ–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –ø–æ –∫–ª–µ—Ç–∫–µ.
			 * –ö–æ–≥–¥–∞ —Ç—ã –∫–ª–∏–∫–∞–µ—à—å, —è –ø–µ—Ä–µ–¥–∞—é –≤ —Ñ—É–Ω–∫—Ü–∏—é 3 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è
			 * –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–µ—Ç–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é —Ç—ã –Ω–∞–∂–∞–ª:
			 * @param {Number} cellIndex - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å –∫–ª–µ—Ç–∫–∏, –æ—Ç 0 –¥–æ 8, –µ—Å–ª–∏ —Å—á–∏—Ç–∞—Ç—å
			 * —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, —Ç–æ –µ—Å—Ç—å
			 * –≤–µ—Ä—Ö–Ω—è—è –ª–µ–≤–∞—è –∫–ª–µ—Ç–∫–∞ 0,
			 * –≤–µ—Ä—Ö–Ω—è—è –ø—Ä–∞–≤–∞—è 2,
			 * –Ω–∏–∂–Ω—è—è –ª–µ–≤–∞—è 6,
			 * –Ω–∏–∂–Ω—è—è –ø—Ä–∞–≤–∞—è 8
			 * @param {String} fillSign - —ç—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —É–∂–µ —Å—Ç–æ–∏—Ç
			 * –≤ –∫–ª–µ—Ç–∫–µ - –∫—Ä–µ—Å—Ç–∏–∫ –∏–ª–∏ –Ω–æ–ª–∏–∫ –∏–ª–∏ –ø—É—Å—Ç–æ. –ï—Å–ª–∏ —Ç–∞–º –∫—Ä–µ—Å—Ç–∏–∫ –∏–ª–∏ –Ω–æ–ª–∏–∫ -
			 * —Ç–æ —Ç–∏–ø–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞ "X" –∏–ª–∏ "O", –µ—Å–ª–∏ –ø—É—Å—Ç–æ - undefined.
			 */

			function createScoreHolder() {
				return {
					rows: {},
					cols: {},
					diagonals: {
						left: 0,
						right: 0,
					},
				};
			}

			function fillPlayerScore(x, y, playerSign) {
				const playerScores = game.scores[playerSign];
				playerScores.rows[x] = (playerScores.rows[x] || 0) + 1;
				playerScores.cols[y] = (playerScores.cols[y] || 0) + 1;
				if (x === y) playerScores.diagonals.left++;
				if (x + y === fieldSize - 1) playerScores.diagonals.right++;
				game.turnCount++;
				game.field[x * fieldSize + y] = playerSign;
			}

			function convertCellIndexToXY(cellIndex) {
				return {
					x: Math.floor(cellIndex / fieldSize),
					y: cellIndex % fieldSize,
				};
			}

			function getWinner(x, y, playerSign) {
				const playerScores = game.scores[playerSign];
				if (
					playerScores.rows[x] === fieldSize ||
					playerScores.cols[y] === fieldSize ||
					playerScores.diagonals.left === fieldSize ||
					playerScores.diagonals.right === fieldSize
				) {
					return playerSign;
				}
				if (game.turnCount === fieldSize * fieldSize) {
					return "draw";
				}
			}

			function makeTurn(cellIndex, playerSign) {
				const { x, y } = convertCellIndexToXY(cellIndex);
				fillPlayerScore(x, y, playerSign);
				fill(cellIndex, playerSign);
				const winner = getWinner(x, y, playerSign);
				if (winner) {
					game.winner = winner;
					showWinner();
				}
			}

			function showWinner() {
				setTimeout(() => {
					alert(
						game.winner === "draw"
							? "It's a fucking draw, noob!"
							: `${game.winner} wins!`
					);
				}, 250);
			}

			function getRandomEmptyCellIndex() {
				const emptyCellIndexes = game.field
					.map((sign, index) => (sign !== undefined ? undefined : index))
					.filter((value) => value !== undefined);
				const randomArrayIndex = _.random(0, emptyCellIndexes.length - 1);
				return emptyCellIndexes[randomArrayIndex];
			}

			const game = {
				field: new Array(fieldSize * fieldSize).fill(),
				scores: {
					X: createScoreHolder(),
					O: createScoreHolder(),
				},
				turnCount: 0,
				/** `playerSign` or "draw" or undefined */
				winner: undefined,
			};

			function handleCellClick(cellIndex, fillSign) {
				if (fillSign || game.winner) return;
				makeTurn(cellIndex, "X");
				if (game.winner) return;

				// Making AI turn
				const randomIndex = getRandomEmptyCellIndex();
				makeTurn(randomIndex, "O");
			}

			/**
			 * –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–ª–µ—Ç–∫—É –∑–Ω–∞—á–µ–Ω–∏–µ–º.
			 * –î—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, –µ—Å–ª–∏ –ø–æ –Ω–∞–∂–∞—Ç–∏—é –Ω–∞ –∫–ª–µ—Ç–∫—É —Ç—ã —Ö–æ—á–µ—à—å,
			 * —á—Ç–æ–±—ã –≤ –Ω–µ—ë –ø–æ—Å—Ç–∞–≤–∏–ª—Å—è –∫—Ä–µ—Å—Ç–∏–∫, —Ç—ã –≤—ã–∑—ã–≤–∞–µ—à—å fill(4, "X").
			 * –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, —Ç—ã —Ç—É–¥–∞ –º–æ–∂–µ—à—å –ø–µ—Ä–µ–¥–∞—Ç—å —á—Ç–æ —É–≥–æ–¥–Ω–æ, —Ö–æ—Ç—å fill(0, "Z")
			 * –∏ —Å–¥–µ–ª–∞—Ç—å –≤–º–µ—Å—Ç–æ –∫—Ä–µ—Å—Ç–∏–∫–æ–≤ –Ω–æ–ª–∏–∫–æ–≤ —Å–≤–æ—é –∏–≥—Ä—É —Å "Y", "Z", –±–ª–µ–∫ –¥–∂–µ–∫–æ–º
			 * –∏ —à–ª—é—Ö–∞–º–∏.
			 * @param {Number} cellIndex - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å –∫–ª–µ—Ç–∫–∏
			 * @param {String} sign - —á–µ–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–ª–µ—Ç–∫—É, –∫—Ä–µ—Å—Ç–∏–∫–æ–º –∏–ª–∏ –Ω–æ–ª–∏–∫–æ–º
			 */
			function fill(cellIndex, sign) {
				const cellEl = document.getElementById(`col${cellIndex}`);
				cellEl.classList.add("filled");
				cellEl.dataset.fillSign = sign;
				cellEl.innerHTML = `<div>${sign}</div>`;
			}
		</script>
	</body>
</html>
